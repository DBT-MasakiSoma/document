
= OMS Document Check Tool
:toc:
:toc-title: 目次
:toclevels: 3

== 仮想環境の作成
1. プロジェクトディレクトリに移動する。
`cd C:\path\to\your\project`

2. 仮想環境を作成する。
`python -m venv venv`

3. 仮想環境をアクティブにする。
`venv\Scripts\activate`

4. `requirements.txt` から依存関係をインストールする。
`pip install -r requirements.txt`

== 実行ファイルの作成
1. `OMS_Document_Check_Tool.spec` ファイルを使用して実行ファイルを作成する。
`pyinstaller OMS_Document_Check_Tool.spec`

2. 実行ファイルは、`dist` フォルダ内に生成される。

== 使用方法
生成された実行ファイルを実行してください。実行ファイルは、`dist` ディレクトリ内に生成される。
実行ファイルを`dist` ディレクトリから移動させる場合は、`OMS_Document_Check_Tool` フォルダごと移動する。

`.\dist\OMS_Document_Check_Tool\OMS_Document_Check_Tool.exe`

== レビュー観点
このアプリには、以下のレビュー観点が実装されている。

=== APIプロパティ整合性チェック
この機能は、指定されたOpenAPI定義書に記載されているプロパティの整合性をチェックする。具体的には、以下の処理を行う。

1. **設定の読み込み**:
   - `review_config.json` からYAMLプロパティのキーを取得し、`exclude_list.json` から除外するプロパティのリストを読み込む。

2. **YAMLファイルの読み込み**:
   - 指定されたファイルパスからYAMLファイルを読み込み、内容を解析する。

3. **プロパティの抽出**:
   - YAMLデータから`components.schemas` セクションを探し、各スキーマのプロパティを抽出する。
   - 各プロパティについて、指定されたプロパティキーに基づいて、データ型やバリデーション情報を収集する。
   - プロパティの行番号も取得し、後の比較に役立てる。

4. **プロパティの比較**:
   - 指定されたOpenAPI定義書と、アプリ内に登録されている他のOpenAPI定義書との間で、プロパティの整合性を比較する。
   - 比較対象のプロパティが除外リストに含まれていない場合、各プロパティの値を比較し、一致しない場合はその情報を結果として記録する。

5. **結果の生成**:
   - 不一致が見つかった場合、対象のプロパティと比較対象のプロパティの詳細情報を含む結果を生成する。
   - 結果には、プロパティ名、値、行番号、比較ファイル名などが含まれる。

このプロセスにより、OpenAPI定義書内のプロパティが一貫して定義されているかどうかを確認し、APIの整合性を保つことができる。

=== クラス呼び出し整合性チェック
この機能は、指定されたアプリケーション定義書に記載されたクラス・メソッドのイン/アウト定義が、他の定義書と整合しているかをチェックします。具体的には、以下の処理を行う。

1. **設定の読み込み**:
   - `review_config.json` から、アプリケーション定義書のセクションやパラメータのキーを取得する。

2. **ファイルの情報抽出**:
   - 指定されたファイルパスからアプリケーション定義書を読み込み、文書名やセクションを抽出する。
   - 特に、処理詳細セクションからプロセスの詳細を抽出し、各プロセスに関連するドメインやデータアクセスの情報を整理する。

3. **パラメータの抽出**:
   - 各プロセスに関連する入力および出力パラメータを抽出し、整理する。
   - パラメータは、定義書内のテーブルから取得され、適切にフォーマットされる。

4. **比較ファイルの情報取得**:
   - 対象ファイルに基づいて、比較対象となるファイルのパスとタイプを取得する。

5. **比較対象ファイルの処理**:
   - 比較対象のファイルに対しても同様に情報を抽出し、各クラスの入力および出力パラメータを整理する。

6. **整合性の比較**:
   - 対象ファイルの情報と比較対象ファイルの情報を照合し、入力および出力パラメータの不一致を検出する。
   - 不一致が見つかった場合、余剰または欠如の情報を含む結果を生成する。

7. **結果の生成**:
   - 比較結果には、対象ファイルのパラメータ情報、行番号、比較ファイル名、比較対象のパラメータ情報などが含まれる。

このプロセスにより、アプリケーション定義書内のクラス呼び出しが一貫して定義されているかどうかを確認し、システム全体の整合性を保つことができる。

=== ERD整合性チェック
この機能は、指定されたデータアクセス定義書に記載されたSQLとERDとの整合性をチェックします。具体的には、以下の処理を行う。

1. **設定の読み込み**:
   - `review_config.json` から、SQLブロックのプレフィックスやERDのセクション名、カラム名、フィールド名などの設定を読み込む。

2. **AsciidocからSQLの抽出**:
   - 指定されたAsciidocファイルからSQLブロックを抽出します。SQLブロックは、特定のプレフィックスで始まり、ブロックの開始と終了を示すデリミタで囲まれる。

3. **SQLの解析**:
   - 抽出したSQLを解析し、使用されているテーブル名、カラム名、共通テーブル式（CTE）を特定します。この情報は、後の整合性チェックに使用される。

4. **ERDの解析**:
   - 指定されたERDファイルを読み込み、テーブル名とそのフィールド（カラム）を抽出します。ERDの情報は、SQLと比較するための基準となる。

5. **SQLとERDの比較**:
   - 抽出したSQLのテーブル名とカラム名をERDの情報と比較する。
   - SQLに含まれるテーブルがERDに存在しない場合や、カラムがERDに定義されていない場合は、不一致として記録する。

6. **不一致の記録**:
   - 不一致が見つかった場合、対象のテーブル名やカラム名、行番号、ERDファイル名などの情報を含む結果を生成する。

7. **結果の生成**:
   - 最終的に、不一致のリストを生成し、整合性チェックの結果を返す。

このプロセスにより、データアクセス定義書内のSQLがERDに基づいて正しく定義されているかどうかを確認し、データベース設計の整合性を保つことができる。

== 共通関数
このアプリケーションでは、以下の共通関数が実装されています。これらの関数は、設定ファイルの読み込みやファイルパスの取得に使用される。

=== 1. `load_json`

- **説明**: 指定されたJSONファイルを読み込み、その内容を辞書形式で返す。
- **処理内容**:
  - アプリケーションがフリーズされているかどうかを確認し、適切なベースパスを設定する。
  - 指定されたファイル名に基づいて、JSONファイルのパスを構築する。
  - ファイルを開き、内容を読み込んで辞書として返す。

=== 2. `save_json`

- **説明**: 指定されたJSONファイルにデータを保存する。
- **処理内容**:
  - アプリケーションがフリーズされているかどうかを確認し、適切なベースパスを設定する。
  - 指定されたファイル名に基づいて、JSONファイルのパスを構築する。
  - データをJSON形式でファイルに書き込む。

=== 3. `get_file_path_by_id`

- **説明**: 指定されたファイルIDに基づいて、対応するファイルのパスを取得する。
- **処理内容**:
  - `upload_file_info.json` からファイル情報を読み込む。
  - アプリケーションがフリーズされているかどうかを確認し、適切なベースパスを設定する。
  - ファイルIDに一致するファイル情報を検索し、ファイル名からファイルパスを構築して返す。
  - 一致するファイルが見つからない場合は、空の文字列を返す。

=== 4. `get_target_file_type`

- **説明**: 指定されたファイルパスに基づいて、ファイルのタイプを取得する。
- **処理内容**:
  - `upload_file_info.json` からファイル情報を読み込む。
  - 指定されたファイル名に一致するファイル情報を検索し、そのファイルタイプを取得して返す。
  - 一致するファイルが見つからない場合は、空の文字列を返す。

これらの共通関数は、アプリケーション内での設定管理やファイル操作を効率化し、コードの再利用性を高めるために使用される。

== データ管理機能
このアプリケーションには、ファイルのアップロードおよび削除を管理するためのデータ管理機能が実装されています。具体的には、以下の処理を行う。

=== 1. ファイルのアップロード (`upload_file()`)
- **説明**: クライアントから送信されたファイルをサーバーにアップロードする。
- **処理内容**:
  - リクエストからファイルタイプとファイルを取得する。
  - アップロード先のフォルダを設定し、既存のファイル情報を読み込む。
  - 新しいファイルIDを生成し、各ファイルを保存する。
  - 既存のファイルがアップロードされた場合は、登録日を更新する。
  - アップロード結果をJSON形式で返す。
  - アップロードに成功したファイルとエラーが発生したファイルの情報を含むレスポンスを返す。

=== 2. ファイルの削除 (`delete_file()`)
- **説明**: 指定されたファイルIDに基づいて、サーバー上のファイルを削除する。
- **処理内容**:
  - リクエストから削除するファイルIDを取得する。
  - 既存のファイル情報を読み込み、削除対象のファイルを特定する。
  - 各ファイルを削除し、削除結果をJSON形式で返す。
  - 削除に成功したファイルとエラーが発生した場合のメッセージを含むレスポンスを返す。

これらのデータ管理機能により、アプリケーションはファイルのアップロードと削除を効率的に管理し、ユーザーが必要なファイルを簡単に操作できるようにしている。
